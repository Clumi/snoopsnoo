{% extends "base.html" %}
{% block title %} - Subreddit : /r/{{subreddit.display_name}} {% endblock %}
{% block nav_subreddits %}active{% endblock %}

{% import "snoopsnoo_macros.html" as snoopsnoo_macros %}

{% block content %}
	<div class="container margin-20">
		{{ snoopsnoo_macros.subreddits_breadcrumbs(breadcrumbs) }}

		<div class="row">
			<div class="col-md-8">
				{{ snoopsnoo_macros.subreddit_listing(subreddit, all_subreddit_categories) }}
			</div>
			<div class="col-md-4">
				{% if related_subreddits %}
				<div class="panel panel-default related-subreddits">
					<div class="panel-heading big text-lowercase">
						Related Subreddits
					</div>
					<div class="panel-body">
						<ul class="list-inline">
						{% for r in related_subreddits %}
							<li><a href="{{ url_for("subreddit", subreddit_name=r.display_name) }}">/r/{{ r.display_name }}</a></li>
						{% endfor %}
						</ul>
					</div>
				</div>
				{% endif %}
			</div>
		</div>
		
		<div class="row margin-20">
			<div class="col-md-9">
				<h3 class="big margin-btm-20 no-top-margin"><strong>Frontpage Preview</strong></h3>
				<div id="subreddit-frontpage" class="subreddit-frontpage">
					<p id="frontpage-loading" class="text-muted">Loading frontpage preview <i class="fa fa-spinner fa-spin margin-lft-10"></i></p>
				</div>
			</div>
			<div class="col-md-3">
				<h3 class="big margin-btm-20 no-top-margin"><strong>All Topics</strong></h3>
				{{ snoopsnoo_macros.topics_menu(root["children"]) }}
			</div>
		</div>
	</div>

	<script>
	$(function () {
		var sub_url = "http://www.reddit.com/r/{{ subreddit.display_name}}.json";
	    $.ajax({
	        url: sub_url,
	        timeout: 30000,
	    }).done(function(data) {
	    	$.ajax({
		        url: "/subreddit_frontpage",
		        type: "POST",
		        contentType: "application/json",
		        data: JSON.stringify(data),
		    }).done(function(response) {
		    	$("#subreddit-frontpage").html(response);
		    });	        
	    }).fail(function(jqXHR, status_text, error_thrown) {
	    	if(jqXHR.status===404) {
	    		$("#frontpage-loading").html('<span class="text-danger"><strong>Subreddit not found. It may have been deleted or banned.</strong></span>');
	    	} else {
	    		$("#frontpage-loading").text("Frontpage preview failed &mdash; reddit may be too busy right now. Refresh the page after a few seconds to try again.");
	    	}
	    });
	});
	</script>
{% endblock %}